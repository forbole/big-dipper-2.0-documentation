---
title: v2.0.0 to v3.0.0
sidebar_position: 2
---

This guide provides details for upgrade from v2.0.0 to v3.0.0.  
If you are **NOT** using PostgreSQL database, you should <ins>only</ins> follow the steps described in `Update branch to v3` section and skip the rest of the guide. 

## Update branch to v3
Pull the changes from `v3.0.0-stargate` (v0.42.x/stargate) or `v3.0.0` (v0.44.x and above) tag to you branch depending on cosmos sdk version being used. 
```
git checkout <your chain base>
git fetch --tags
git pull v3.0.0-stargate
```
 **Do __NOT__ install or restart bdjuno yet if you're using PostgreSQL database and you are going to perform table migration.**  
If you are not using PostgreSQL database you can now install the changes by running `make install` and restart the bdjuno.

## Migration to table partitioning
In order to efficiently query the database with large amount of transactions and messages,
we've implemented PostgreSQL [Table Partitioning](https://www.postgresql.org/docs/10/ddl-partitioning.html) feature
starting from `v3.0.0` which turns the `transaction` and `message` tables into partitioned
tables and creates partitions by a certain interval of heights that must be set inside 
[config.yaml file](./../config/config.md#database). 

### Prepare for the migration
1. Add custom address parser inside `bdjuno/database/migrate/utils.go` file, 
or leave it empty if no custom address parser is needed. 
```go
// If no custom address parser
var CustomAccountParser = []string{}
```
```go
// Take desmos chain as example:
var CustomAccountParser = []string{
	"sender", "receiver", "user", "counterparty", "blocker", "blocked",
}
```
2. Checkout inisde **/bdjuno** directory and run:
```shell
$ make install
$ bdjuno migrate v3
```
Two additional fields inside `.bdjuno/config.yaml` file will be created under the database section. 
Don't panic if you see the message pops up: `partition batch size is set to 0, skipping migration`, 
because these 2 fields need to be modified before starting the migration, for example:
```yaml
database:
    # How many blocks for each partition. 
    # In this example partition is created per 100,000 blocks.
    partition_size: 100000
    
    # How many rows of transactions are migrated per batch 
    partition_batch: 1000 
```
Read [Database Config Reference](./../config/config.md#database) for more information.

### Start the migration
**Make sure bdjuno is stopped prior the migration.**  
We recommend setting up the migration process as a system service and be patient as the migration might take some time, depending on the database size.

```shell
$ sudo tee /etc/systemd/system/bdjuno-migrate-v3.service > /dev/null <<EOF
[Unit]
Description=BDJuno Table Partition Migration v3
After=network-online.target

[Service]
User=$USER
ExecStart=$GOPATH/bin/bdjuno migrate v3
LimitNOFILE=4096

[Install]
WantedBy=multi-user.target
EOF
```

Then you need to enable and start the service:
```shell 
$ sudo systemctl enable bdjuno-migrate-v3.service
$ sudo systemctl start bdjuno-migrate-v3.service
```

BDjuno will now start migration which will:  
- rename `transaction` & `message` tables to `transaction_old` & `message_old`  
- rename related transaction and message indexes; 
- create new `transaction` & `message` tables with partition;
- create indexes for new transaction and message table  
- migrate rows with data by batch from old to new tables;
- drop old function `messages_by_address` and create a new one;

While the migration is ongoing, you can already restart bdjuno to start syncing the latest data and it will be stored inside new partitioned tables:
```shell
$ bdjuno start
```


### Migration completed
If no error message pops up, the migration is completed. For safety reason it does __not__ drop old tables `transaction_old` and `message_old`. 
You might want to drop them after the data consistency is verified (or don't even drop them).

### Revert
In any case that the migration fails, you can always revert back the changes without loosing any data. 
You might find the below SQL script helpful for altering tables and indexes back to the original names.  
**Please ensure bdjuno is stopped prior running the script.** 
```sql
ALTER TABLE transaction_old RENAME TO transaction;
ALTER INDEX transaction_old_pkey RENAME TO transaction_pkey;
ALTER INDEX transaction_old_hash_index RENAME TO transaction_hash_index;
ALTER INDEX transaction_old_height_index RENAME TO transaction_height_index;
ALTER TABLE transaction RENAME CONSTRAINT transaction_old_height_fkey TO transaction_height_fkey;

ALTER TABLE message_old RENAME TO message;
ALTER INDEX message_old_involved_accounts_addresses RENAME TO message_involved_accounts_addresses;
ALTER INDEX message_old_transaction_hash_index RENAME TO message_transaction_hash_index;
ALTER INDEX message_old_type_index RENAME TO message_type_index;
ALTER TABLE message RENAME CONSTRAINT message_old_transaction_hash_fkey TO message_transaction_hash_fkey;
```

When the tables are altered back, install and run your previous BDjuno branch which 
will continue to parse the data from the height before the migration started.