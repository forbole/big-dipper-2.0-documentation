<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.4">
<title data-react-helmet="true">v2.0.0 to v3.0.0 | Big Dipper 2.0 Documentation</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="https://docs.bigdipper.live/cosmos-based/parser/migrations/v3.0.0"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="v2.0.0 to v3.0.0 | Big Dipper 2.0 Documentation"><meta data-react-helmet="true" name="description" content="This guide provides details for the upgrade from v2.0.0 to v3.0.0."><meta data-react-helmet="true" property="og:description" content="This guide provides details for the upgrade from v2.0.0 to v3.0.0."><meta data-react-helmet="true" property="og:image" content="https://docs.bigdipper.live/assets/cover.png"><meta data-react-helmet="true" name="twitter:image" content="https://docs.bigdipper.live/assets/cover.png"><link data-react-helmet="true" rel="shortcut icon" href="/assets/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://docs.bigdipper.live/cosmos-based/parser/migrations/v3.0.0"><link data-react-helmet="true" rel="alternate" href="https://docs.bigdipper.live/cosmos-based/parser/migrations/v3.0.0" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://docs.bigdipper.live/cosmos-based/parser/migrations/v3.0.0" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.bd168e87.css">
<link rel="preload" href="/assets/js/runtime~main.f778b9ca.js" as="script">
<link rel="preload" href="/assets/js/main.9d33f902.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_1oUP">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><a class="navbar__brand" href="/"><img src="/assets/logo.png" alt="Big Dipper logo" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/assets/logo.png" alt="Big Dipper logo" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><b class="navbar__title">Big Dipper 2.0 Documentation</b></a></div><div class="navbar__items navbar__items--right"><div class="react-toggle toggle_3Zt9 react-toggle--disabled"><div class="react-toggle-track" role="button" tabindex="-1"><div class="react-toggle-track-check"><span class="toggle_71bT">üåú</span></div><div class="react-toggle-track-x"><span class="toggle_71bT">üåû</span></div><div class="react-toggle-thumb"></div></div><input type="checkbox" class="react-toggle-screenreader-only" aria-label="Switch between dark and light mode"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper doc-page"><div class="docPage_31aa"><button class="clean-btn backToTopButton_35hR" type="button" title="Scroll to top"><svg viewBox="0 0 24 24" width="28"><path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z" fill="currentColor"></path></svg></button><aside class="docSidebarContainer_3Kbt"><div class="sidebar_15mo"><nav class="menu thin-scrollbar menu_Bmed menuWithAnnouncementBar_2WvA"><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/">Overview</a></li><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#">Cosmos Based Chains</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/cosmos-based/overview">Overview</a></li><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#" tabindex="0">BDJuno</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/cosmos-based/parser/overview">Overview</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/cosmos-based/parser/database">1. Setup the database</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/cosmos-based/parser/setup">2. Setup and run BDJuno</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/cosmos-based/parser/hasura">3. Setup and run Hasura</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">Config reference</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/cosmos-based/parser/custom-chains">Custom chains</a></li><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#" tabindex="0">Migrations</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/cosmos-based/parser/migrations/v2.0.0">v1.0.0 to v2.0.0</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link menu__link--active active" tabindex="0" href="/cosmos-based/parser/migrations/v3.0.0">v2.0.0 to v3.0.0</a></li></ul></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">Big Dipper UI</a></li></ul></li></ul></nav></div></aside><main class="docMainContainer_3ufF"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_3FnS"><div class="docItemContainer_33ec"><article><div class="tocCollapsible_1PrD tocMobile_3Hoh"><button type="button" class="clean-btn tocCollapsibleButton_2O1e">On this page</button></div><div class="markdown"><header><h1 class="h1Heading_27L5">v2.0.0 to v3.0.0</h1></header><p>This guide provides details for the upgrade from v2.0.0 to v3.0.0.<br>
If you are <strong>NOT</strong> using PostgreSQL database, you should <ins>only</ins>
follow the steps described in the <code>Update branch to v3</code> section and skip the rest of the guide. </p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="update-branch-to-v3"></a>Update branch to v3<a class="hash-link" href="#update-branch-to-v3" title="Direct link to heading">#</a></h2><p>Pull the changes from <code>v3.0.0-stargate</code> (v0.42.x/stargate) or <code>v3.0.0</code> (v0.44.x and above)
tag to your branch depending on the cosmos sdk version being used in your project. </p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">$ git fetch --tags</span></span><span class="token-line" style="color:#393A34"><span class="token plain">$ git checkout &lt;your chain base&gt;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">$ git checkout -b merge/v3.0.0-stargate</span></span><span class="token-line" style="color:#393A34"><span class="token plain">$ git merge base-v3.0.0-stargate</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Fix all merge conflicts and then install the latest BDJuno version </p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">$ make install</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="migrate-config-file-to-v3"></a>Migrate config file to v3<a class="hash-link" href="#migrate-config-file-to-v3" title="Direct link to heading">#</a></h3><p>Once installed you will need to migrate <code>config.yaml</code> file to v3. To do that run: </p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly shell"><pre tabindex="0" class="prism-code language-shell codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">$ bdjuno migrate v3</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>This will create additional sections inside <code>.yaml</code> file for table partition and hasura actions config. </p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="remove-hasura-actions-service"></a>Remove Hasura Actions service<a class="hash-link" href="#remove-hasura-actions-service" title="Direct link to heading">#</a></h3><p>From <code>v3.0.0</code> Hasura Actions have been merged with BDJuno&#x27; to run on a single <code>start</code> command.
This improves the BDJuno setup making it easier for users to follow. Find out more details how to enable and configure <a href="/cosmos-based/parser/hasura#configure-hasura-actions">Hasura Actions</a></p><p>If you run Hasura Actions as a background service you should now stop it and remove it from the system. </p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="update-service"></a>Update service<a class="hash-link" href="#update-service" title="Direct link to heading">#</a></h3><p>If you are running BDJuno as a background service, you will need to update it before restarting. Edit <code>/etc/systemd/system/bdjuno.service</code> file and replace <code>parse</code> with <code>start</code> command at the ExecStart line. </p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly shell"><pre tabindex="0" class="prism-code language-shell codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">nano</span><span class="token plain"> /etc/systemd/system/bdjuno.service</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">[Unit]</span></span><span class="token-line" style="color:#393A34"><span class="token plain">Description=BDJuno parser</span></span><span class="token-line" style="color:#393A34"><span class="token plain">After=network-online.target</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">[Service]</span></span><span class="token-line" style="color:#393A34"><span class="token plain">User=$USER</span></span><span class="token-line" style="color:#393A34"><span class="token plain">ExecStart=$GOPATH/bin/bdjuno start</span></span><span class="token-line" style="color:#393A34"><span class="token plain">Restart=always</span></span><span class="token-line" style="color:#393A34"><span class="token plain">RestartSec=3</span></span><span class="token-line" style="color:#393A34"><span class="token plain">LimitNOFILE=4096</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">[Install]</span></span><span class="token-line" style="color:#393A34"><span class="token plain">WantedBy=multi-user.target</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Then reload the configuration files</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">$ sudo systemctl daemon-reload</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>‚ö†Ô∏è  <strong>Do <strong>NOT</strong> restart BDJuno yet if you&#x27;re using PostgreSQL</strong>
<strong>database and you are going to perform table migration. Proceed to the next step instead.</strong>  </p><p>If you are not using the PostgreSQL database you can now start BDJuno </p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">$ bdjuno start</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>or if you are running it as a background service run</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly shell"><pre tabindex="0" class="prism-code language-shell codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> systemctl restart bdjuno.service</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="migration-to-postgresql-table-partitioning"></a>Migration to PostgreSQL table partitioning<a class="hash-link" href="#migration-to-postgresql-table-partitioning" title="Direct link to heading">#</a></h2><p>In order to efficiently query the database with large amount of transactions and messages,
we&#x27;ve implemented PostgreSQL <a href="https://www.postgresql.org/docs/10/ddl-partitioning.html" target="_blank" rel="noopener noreferrer">Table Partitioning</a>
feature starting from <code>v3.0.0</code> which turns the <code>transaction</code> and <code>message</code> tables into
partitioned tables and creates partitions by a certain interval of heights set inside
<a href="/cosmos-based/parser/config/config#database">config.yaml file</a>. </p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="prepare-for-the-migration"></a>Prepare for the migration<a class="hash-link" href="#prepare-for-the-migration" title="Direct link to heading">#</a></h3><ol><li>Add custom address parser inside <code>bdjuno/database/migrate/utils.go</code> file,
or leave it empty if no custom address parser is needed. </li></ol><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly go"><pre tabindex="0" class="prism-code language-go codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// If no custom address parser</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> CustomAccountParser </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly go"><pre tabindex="0" class="prism-code language-go codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// Take desmos chain as example:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> CustomAccountParser </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string" style="color:#e3116c">&quot;sender&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;receiver&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;user&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;counterparty&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;blocker&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;blocked&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><ol start="2"><li>Update partition values inside config.yaml file  </li></ol><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">database</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># How many blocks for each partition. </span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># In this example partition is created per 100,000 blocks.</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">partition_size</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">100000</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># How many rows of transactions are migrated per batch </span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">partition_batch</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1000</span><span class="token plain"> </span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Read <a href="/cosmos-based/parser/config/config#database">Database Config Reference</a> for more information.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="start-the-migration"></a>Start the migration<a class="hash-link" href="#start-the-migration" title="Direct link to heading">#</a></h3><p><strong>Make sure BDJuno is stopped before the migration.</strong><br>
We recommend setting up the migration process as a system service and being patient
as the migration might take some time, depending on the database size.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly shell"><pre tabindex="0" class="prism-code language-shell codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">tee</span><span class="token plain"> /etc/systemd/system/bdjuno-migrate-v3.service </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> /dev/null </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token string" style="color:#e3116c">EOF</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">[Unit]</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">Description=BDJuno Table Partition Migration v3</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">After=network-online.target</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="display:inline-block;color:#e3116c">
</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">[Service]</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">User=</span><span class="token string environment constant" style="color:#36acaa">$USER</span><span class="token string" style="color:#e3116c"></span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">ExecStart=</span><span class="token string variable" style="color:#36acaa">$GOPATH</span><span class="token string" style="color:#e3116c">/bin/bdjuno migrate v3</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">LimitNOFILE=4096</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">Restart=no</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="display:inline-block;color:#e3116c">
</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">[Install]</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">WantedBy=multi-user.target</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">EOF</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Then you need to enable and start the service:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly shell"><pre tabindex="0" class="prism-code language-shell codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> systemctl </span><span class="token builtin class-name">enable</span><span class="token plain"> bdjuno-migrate-v3.service</span></span><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> systemctl start bdjuno-migrate-v3.service</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>BDJuno will now start migration which will:  </p><ul><li>rename <code>transaction</code> &amp; <code>message</code> tables to <code>transaction_old</code> &amp; <code>message_old</code>  </li><li>rename related transaction and message indexes; </li><li>create new <code>transaction</code> &amp; <code>message</code> tables with partition;</li><li>create indexes for new transaction and message table  </li><li>migrate rows with data by batch from old to new tables;</li><li>drop old function <code>messages_by_address</code> and create a new one;</li></ul><p>While the migration is ongoing, you can already restart BDJuno to start
syncing the latest data and it will be stored inside new partitioned tables:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly shell"><pre tabindex="0" class="prism-code language-shell codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">$ bdjuno start</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="hasura"></a>Hasura<a class="hash-link" href="#hasura" title="Direct link to heading">#</a></h3><p>Since <code>v3.0.0</code>, Hasura actions&#x27; handlers can use custom endpoints other than http://localhost:3000.
Hasura will read from the <code>ACTION_BASE_URL</code> environmental variable as the action handler&#x27;s base URL.
To update it, you will need to re-create a new docker container, specifying the variable with the <code>-e</code> flag:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">-e ACTION_BASE_URL=&quot;Base URL for Hasura Actions Handlers&quot;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>For more details, check out <a href="/cosmos-based/parser/hasura#installing-hasura">Installing Hasura</a></p><p>You will also need to re-apply hasura metadata to match the latest table setup:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly shell"><pre tabindex="0" class="prism-code language-shell codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token builtin class-name">cd</span><span class="token plain"> /path/to/bdjuno/hasura</span></span><span class="token-line" style="color:#393A34"><span class="token plain">$ hasura metadata apply --endpoint </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">your-endpoint</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> --admin-secret </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">hasura_password</span><span class="token operator" style="color:#393A34">&gt;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="migration-completed"></a>Migration completed<a class="hash-link" href="#migration-completed" title="Direct link to heading">#</a></h3><p>Once all transactions and messages have been migrated to new partitioned tables the migration is completed. For the safety reasons
it does <strong>not</strong> drop old tables <code>transaction_old</code> and <code>message_old</code>.
You might want to drop them after the data consistency is verified and they are no longer needed.   </p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly sql"><pre tabindex="0" class="prism-code language-sql codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">DROP</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">TABLE</span><span class="token plain"> transaction_old</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">DROP</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">TABLE</span><span class="token plain"> message_old</span><span class="token punctuation" style="color:#393A34">;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="revert"></a>Revert<a class="hash-link" href="#revert" title="Direct link to heading">#</a></h3><p>In any case that the migration fails, you can always revert the changes without losing any data.
You might find the below SQL script helpful for altering tables and indexes back to the original names.
Remember to drop the new <code>transaction</code> and <code>message</code> tables, along with the messages_by_address function.</p><p><strong>Please ensure BDJuno is stopped prior to running the script.</strong> </p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly sql"><pre tabindex="0" class="prism-code language-sql codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">ALTER</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">TABLE</span><span class="token plain"> transaction_old </span><span class="token keyword" style="color:#00009f">RENAME</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">TO</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">transaction</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">ALTER</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">INDEX</span><span class="token plain"> transaction_old_pkey </span><span class="token keyword" style="color:#00009f">RENAME</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">TO</span><span class="token plain"> transaction_pkey</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">ALTER</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">INDEX</span><span class="token plain"> transaction_old_hash_index </span><span class="token keyword" style="color:#00009f">RENAME</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">TO</span><span class="token plain"> transaction_hash_index</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">ALTER</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">INDEX</span><span class="token plain"> transaction_old_height_index </span><span class="token keyword" style="color:#00009f">RENAME</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">TO</span><span class="token plain"> transaction_height_index</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">ALTER</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">TABLE</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">transaction</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">RENAME</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">CONSTRAINT</span><span class="token plain"> transaction_old_height_fkey </span><span class="token keyword" style="color:#00009f">TO</span><span class="token plain"> transaction_height_fkey</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">ALTER</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">TABLE</span><span class="token plain"> message_old </span><span class="token keyword" style="color:#00009f">RENAME</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">TO</span><span class="token plain"> message</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">ALTER</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">INDEX</span><span class="token plain"> message_old_involved_accounts_addresses </span><span class="token keyword" style="color:#00009f">RENAME</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">TO</span><span class="token plain"> message_involved_accounts_addresses</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">ALTER</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">INDEX</span><span class="token plain"> message_old_transaction_hash_index </span><span class="token keyword" style="color:#00009f">RENAME</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">TO</span><span class="token plain"> message_transaction_hash_index</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">ALTER</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">INDEX</span><span class="token plain"> message_old_type_index </span><span class="token keyword" style="color:#00009f">RENAME</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">TO</span><span class="token plain"> message_type_index</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">ALTER</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">TABLE</span><span class="token plain"> message </span><span class="token keyword" style="color:#00009f">RENAME</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">CONSTRAINT</span><span class="token plain"> message_old_transaction_hash_fkey </span><span class="token keyword" style="color:#00009f">TO</span><span class="token plain"> message_transaction_hash_fkey</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">CREATE</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">FUNCTION</span><span class="token plain"> messages_by_address</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    addresses </span><span class="token keyword" style="color:#00009f">TEXT</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">types</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">TEXT</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;limit&quot;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">BIGINT</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">100</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;offset&quot;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">BIGINT</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">RETURNS</span><span class="token plain"> SETOF message </span><span class="token keyword" style="color:#00009f">AS</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">$$</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> message</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">transaction_hash</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> message</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">index</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> message</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">type</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> message</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">value</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> message</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">involved_accounts_addresses</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> message</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         </span><span class="token keyword" style="color:#00009f">JOIN</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">transaction</span><span class="token plain"> t </span><span class="token keyword" style="color:#00009f">on</span><span class="token plain"> message</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">transaction_hash </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> t</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">hash</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">cardinality</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">types</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">OR</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">ANY</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">types</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">AND</span><span class="token plain"> addresses </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> involved_accounts_addresses</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">ORDER</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">BY</span><span class="token plain"> height </span><span class="token keyword" style="color:#00009f">DESC</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">LIMIT</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;limit&quot;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">OFFSET</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;offset&quot;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">$$ </span><span class="token keyword" style="color:#00009f">LANGUAGE</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">sql</span><span class="token plain"> STABLE</span><span class="token punctuation" style="color:#393A34">;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>When the tables are altered back, install and run your previous BDJuno branch which
will continue to parse the data from the height before the migration started.</p></div><footer class="row docusaurus-mt-lg"><div class="col"></div><div class="col lastUpdated_3DPF">Last updated on <b><time datetime="2022-04-19T13:19:50.000Z">4/19/2022</time></b></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/cosmos-based/parser/migrations/v2.0.0"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">¬´ v1.0.0 to v2.0.0</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/cosmos-based/frontend/setup"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Setup ¬ª</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_35-E thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#update-branch-to-v3" class="table-of-contents__link">Update branch to v3</a><ul><li><a href="#migrate-config-file-to-v3" class="table-of-contents__link">Migrate config file to v3</a></li><li><a href="#remove-hasura-actions-service" class="table-of-contents__link">Remove Hasura Actions service</a></li><li><a href="#update-service" class="table-of-contents__link">Update service</a></li></ul></li><li><a href="#migration-to-postgresql-table-partitioning" class="table-of-contents__link">Migration to PostgreSQL table partitioning</a><ul><li><a href="#prepare-for-the-migration" class="table-of-contents__link">Prepare for the migration</a></li><li><a href="#start-the-migration" class="table-of-contents__link">Start the migration</a></li><li><a href="#hasura" class="table-of-contents__link">Hasura</a></li><li><a href="#migration-completed" class="table-of-contents__link">Migration completed</a></li><li><a href="#revert" class="table-of-contents__link">Revert</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="footer__bottom text--center"></div></div></footer></div>
<script src="/assets/js/runtime~main.f778b9ca.js"></script>
<script src="/assets/js/main.9d33f902.js"></script>
</body>
</html>